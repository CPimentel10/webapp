{% extends 'layouts/default.twig' %}
{% block content %}
    <h1 class="conversation_subject">{{ conversation.subject }}</h1>
    <p class="conversation_header">Started by <a
                href="{{ path('profile', { user_id: conversation.fromUser.id }) }}">{{ conversation.fromUser.name }}</a> on {{ conversation.startedAt|date }}</p>

    <div class="conversation_opening_message">
        <div class="message_body">
            {{ conversation.firstMessage.body|markdown }}
        </div>
    </div>

    {% for message in conversation.replies %}
        <hr/>
        <div class="conversation_reply">
            <div class="message_header">
                <a href="{{ path('profile', { user_id: message.fromUser.id }) }}">{{ message.fromUser.name }}</a> on {{ message.createdAt|date }}
                {% if not message.isRead %}
                    <span class="label label-default">UNREAD</span> {# this tells a user if the other person has read this message or not yet #}
                {% endif %}
            </div>
            <div class="message_body">
                {{ message.body|markdown }}
            </div>
        </div>
    {% endfor %}

    <hr/>
    <div class="reply_form" data-ng-controller="MessageMarkdownController">
        <div role="tabpanel">

          <!-- Nav tabs -->
          <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#reply_write" aria-controls="reply_write" role="tab" data-toggle="tab">Reply</a></li>
            <li role="presentation"><a href="#reply_preview" aria-controls="reply_preview" role="tab" data-toggle="tab" data-ng-click="generatePreview()">Preview</a></li>
          </ul>

          <!-- Tab panes -->
          <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="reply_write" style="min-height: 500px;">
                {{ form_start(message_form) }}
                {{ form_row(message_form.body, { label: false, attr: { style: "min-height: 400px;", "ng-model": "raw_body" } }) }}
                {{ form_row(message_form.submit) }}
                {{ form_end(message_form) }}
                {{ form(message_form) }}
            </div>
            <div role="tabpanel" class="tab-pane" id="reply_preview" style="min-height: 500px;">
                <div data-ng-show="!loading">
                    <span ng-bind-html="preview" data-ng-show="!loadingError"></span>
                    <div class="alert alert-danger" role="alert" data-ng-show="loadingError">
                        <strong>Oops!</strong> There was an error while trying to generate your preview.
                    </div>
                </div>
                <div data-ng-show="loading">
                    <p>Loading...</p>
                </div>
            </div>
          </div>

        </div>
    </div>
{% endblock %}